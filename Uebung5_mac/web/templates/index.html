<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <title>Flask + PostGIS Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body{font-family:system-ui,Arial;padding:24px}
    pre{background:#f7f7f7;padding:12px;border-radius:8px}
    #map{height:480px;border-radius:8px;box-shadow:0 2px 8px #0001;margin-top:16px}
    .hint{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>‚úÖ Service is running</h1>
  <p>If the table below shows data from the database, the connection is OK:</p>
  <div id="out">Loading...</div>

  <h2 style="margin-top:28px">üó∫Ô∏è GeoServer WMS + WFS Vorschau</h2>
  <p class="hint">Raster-Daten (wie mainz.tif) √ºber WMS; Vektor-Daten (PostGIS: points, places) √ºber WFS.</p>
  <div id="map"></div>

  <script>
    fetch('/api/places')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('out').textContent = 'No data.';
          return;
        }
        // Build table
        let html = '<table border="1" cellpadding="6" style="border-collapse:collapse;border-radius:8px;box-shadow:0 2px 8px #0001;background:#fff;">';
        html += '<thead><tr>';
        for (const key of Object.keys(data[0])) html += `<th>${key}</th>`;
        html += '</tr></thead><tbody>';
        for (const row of data) {
          html += '<tr>';
          for (const key of Object.keys(data[0])) html += `<td>${row[key]}</td>`;
          html += '</tr>';
        }
        html += '</tbody></table>';
        document.getElementById('out').innerHTML = html;
      })
      .catch(e => {
        document.getElementById('out').textContent = 'Failed to fetch /api/places: ' + e;
      });
  </script>
  
  <!-- Leaflet + WMS/WFS Beispiel -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Grundkarte (OSM)
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    });

    const map = L.map('map', {
  center: [50.0, 8.27],  // Raum Mainz
      zoom: 10,
      layers: [osm]
    });

  // GeoServer WMS Layer (Workspace: uebung)
    const WMS_URL = 'http://localhost:8080/geoserver/uebung/wms';

  // Layer-Steuerung (ÂàùÂßãÂåñÔºå‰πãÂêéËá™Âä®Ê∑ªÂä†ÊâÄÊúâÂèëÁé∞ÁöÑLayer)
    const layersControl = L.control.layers(
      { 'OpenStreetMap': osm },
      {}
    ).addTo(map);

  // Automatische Erkennung aller WMS und WFS Layer
    (async () => {
      try {
        const capsUrl = WMS_URL + '?service=WMS&request=GetCapabilities';
        console.log('Fetching WMS Capabilities from:', capsUrl);
        
        const resp = await fetch(capsUrl);
        console.log('WMS Capabilities Response Status:', resp.status);
        
        if (!resp.ok) throw new Error('Capabilities HTTP ' + resp.status);
        
        const text = await resp.text();
        console.log('WMS Capabilities Response Length:', text.length);
        
        const xml = new DOMParser().parseFromString(text, 'application/xml');
        console.log('Parsed XML:', xml);
        
        // Alle Layer-Namen auslesen
        const allLayers = Array.from(xml.querySelectorAll('Layer > Name')).map(n => n.textContent || '').filter(Boolean);
        console.log('All layer names found:', allLayers);
        
        // Filter: Nur Layer aus dem uebung Workspace (k√∂nnen ohne Prefix sein)
        // Ignoriere den Root "uebung" Layer selbst
        const wmsLayers = allLayers.filter(n => n !== 'uebung');
        console.log('Filtered WMS/WFS layers (all except "uebung"):', wmsLayers);
        
        if (wmsLayers.length === 0) {
          console.warn('‚ö†Ô∏è No layers found!');
          return;
        }
        
        // F√ºr jeden Layer: WMS hinzuf√ºgen (alle Layer als WMS verf√ºgbar machen)
        wmsLayers.forEach(lyrName => {
          console.log(`‚úì Adding WMS layer: ${lyrName}`);
          const fullLayerName = lyrName.includes(':') ? lyrName : `uebung:${lyrName}`;
          const wmsAuto = L.tileLayer.wms(WMS_URL, { 
            layers: fullLayerName, 
            format: 'image/png', 
            transparent: true 
          });
          layersControl.addOverlay(wmsAuto, `üñºÔ∏è WMS - ${lyrName}`);
        });
        
        // F√ºr alle Layer: WFS/GeoJSON versuchen zu laden (wenn verf√ºgbar)
        console.log('\\n--- Attempting to load vector data via WFS ---');
        const wfsUrl = 'http://localhost:8080/geoserver/uebung/ows';
        
        wmsLayers.forEach(lyrName => {
          const fullLayerName = lyrName.includes(':') ? lyrName : `uebung:${lyrName}`;
          const url = `${wfsUrl}?service=WFS&version=2.0.0&request=GetFeature&typeName=${encodeURIComponent(fullLayerName)}&outputFormat=application/json`;
          
          console.log(`  Attempting WFS for ${lyrName}...`);
          
          fetch(url)
            .then(r => {
              if (!r.ok) throw new Error('WFS HTTP ' + r.status);
              return r.json();
            })
            .then(geojson => {
              if (!geojson.features || geojson.features.length === 0) {
                console.log(`  ‚ÑπÔ∏è ${lyrName}: Keine Vektorfeatures (Raster-Layer)`);
                return;
              }
              
              console.log(`  ‚úì ${lyrName}: ${geojson.features.length} Features`);
              
              const lyr = L.geoJSON(geojson, {
                pointToLayer: (f, latlng) => L.circleMarker(latlng, { 
                  radius: 6, 
                  color: '#d33', 
                  weight: 2, 
                  fillColor: '#f88', 
                  fillOpacity: 0.7 
                }),
                onEachFeature: (f, layer) => {
                  const props = Object.entries(f.properties || {})
                    .map(([k,v]) => `<div><b>${k}</b>: ${v}</div>`)
                    .join('');
                  layer.bindPopup(props || 'No attributes');
                }
              }).addTo(map);
              
              layersControl.addOverlay(lyr, `üìç WFS - ${lyrName}`);
              
              try { 
                map.fitBounds(lyr.getBounds(), { padding: [20,20] }); 
              } catch (e) {
                console.log('Could not fit bounds:', e);
              }
            })
            .catch(err => {
              console.log(`  ‚ÑπÔ∏è ${lyrName}: WFS nicht verf√ºgbar`);
            });
        });
      } catch (e) {
        console.error('‚ùå WMS/WFS Capabilities Error:', e);
      }
    })();

  </script>
</body>
</html>
